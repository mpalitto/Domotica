/*
Author: Matteo Palitto
Date: January 9, 2024 (Updated)

Description: loggingService.mjs
Handles all logging functionality including debug, capture, and diagnostics

NEW FEATURE: Automatically intercepts console.log output and captures
any messages related to the debug device, creating a comprehensive debug log
*/

import { appendFileSync, renameSync, existsSync } from 'fs';
import { debugMode, protocolCapture, sONOFF } from '../sharedVARs.js';

// Store original console.log so we can restore it later
const originalConsoleLog = console.log;

export class LoggingService {
    /**
     * Log debug information for a specific device
     * This is called explicitly from various parts of the code
     */
    static debugLog(deviceID, direction, type, data) {
        if (debugMode.enabled && debugMode.deviceId === deviceID) {
            const timestamp = new Date().toISOString();
            const logEntry = `\n${'='.repeat(80)}\n[${timestamp}] ${direction} - ${type}\n${'-'.repeat(80)}\n${data}\n${'='.repeat(80)}\n`;
            try {
                appendFileSync(`${deviceID}.debug`, logEntry);
            } catch (err) {
                originalConsoleLog('Error writing to debug file:', err);
            }
        }
    }

    /**
     * Log protocol capture information
     */
    static captureLog(direction, data) {
        if (!protocolCapture.enabled || !protocolCapture.logFile) {
            return;
        }
        const timestamp = new Date().toISOString();
        const logEntry = `\n${'='.repeat(80)}\n[${timestamp}] ${direction}\n${'-'.repeat(80)}\n${data}\n${'='.repeat(80)}\n`;
        try {
            appendFileSync(protocolCapture.logFile, logEntry);
        } catch (err) {
            originalConsoleLog('Error writing to capture file:', err);
        }
    }

    /**
     * Auto-enable debug mode for a device with issues
     */
    static enableDebugForDevice(deviceID, reason) {
        originalConsoleLog(`\n${'üîç'.repeat(40)}`);
        originalConsoleLog(`üîç AUTO-ENABLING DEBUG MODE FOR DEVICE: ${deviceID}`);
        originalConsoleLog(`   Reason: ${reason}`);
        originalConsoleLog(`   Debug file: ${deviceID}.debug`);
        originalConsoleLog(`${'üîç'.repeat(40)}\n`);
        
// Rotate existing debug file to .bak
const debugFile = `${deviceID}.debug`;
const bakFile = `${deviceID}.debug.bak`;

if (existsSync(debugFile)) {
    try {
        // Simple rotation - just keep one backup
        if (existsSync(bakFile)) {
            renameSync(bakFile, `${bakFile}.old`);
        }
        renameSync(debugFile, bakFile);
        originalConsoleLog(`üìÅ Rotated old debug file to ${bakFile}`);
    } catch (err) {
        originalConsoleLog(`‚ö†Ô∏è  Could not rotate debug file:`, err.message);
    }
}
        
        // Enable debug mode for this device
        debugMode.enabled = true;
        debugMode.deviceId = deviceID;
        
        // Write initial header to new debug file
        const timestamp = new Date().toISOString();
        const deviceAlias = sONOFF[deviceID]?.alias || 'unknown';
        
        const header = `
${'='.repeat(80)}
DEBUG SESSION STARTED: ${timestamp}
DEVICE ID: ${deviceID}
ALIAS: "${deviceAlias}"
REASON: ${reason}
${'='.repeat(80)}

This file captures ALL activity related to this device including:
- HTTP dispatch requests/responses
- WebSocket connections and messages
- Register, date, update, query actions
- Cloud connection and messages
- State changes and errors
- All console output mentioning this device

${'='.repeat(80)}

`;
        
        try {
            appendFileSync(debugFile, header);
        } catch (err) {
            originalConsoleLog(`‚ö†Ô∏è  Could not write to debug file:`, err.message);
        }
        
        // **Intercept console.log to automatically capture relevant output**
        this.interceptConsoleLog();
    }

    /**
     * Disable debug mode for a device
     */
    static disableDebugForDevice(deviceID) {
        if (debugMode.enabled && debugMode.deviceId === deviceID) {
            originalConsoleLog(`\nüîç Disabling debug mode for ${deviceID}\n`);
            
            // Write footer to debug file
            const timestamp = new Date().toISOString();
            const footer = `
${'='.repeat(80)}
DEBUG SESSION ENDED: ${timestamp}
DEVICE: ${deviceID} "${sONOFF[deviceID]?.alias || 'unknown'}"
${'='.repeat(80)}
`;
            
            try {
                appendFileSync(`${deviceID}.debug`, footer);
            } catch (err) {
                originalConsoleLog(`‚ö†Ô∏è  Could not write footer to debug file:`, err.message);
            }
            
            debugMode.enabled = false;
            debugMode.deviceId = null;
            
            // Restore original console.log
            console.log = originalConsoleLog;
        }
    }

    /**
     * Intercept console.log to automatically capture debug device output
     * This creates a comprehensive log of ALL activity for the debug device
     */
    static interceptConsoleLog() {
        // Replace console.log with our interceptor
        console.log = (...args) => {
            const message = args.join(' ');
            
            // Always print to terminal (normal behavior)
            originalConsoleLog(...args);
            
            // If debug mode enabled, check if message relates to debug device
            if (debugMode.enabled && debugMode.deviceId) {
                const deviceAlias = sONOFF[debugMode.deviceId]?.alias;
                
                // Check if message contains device ID, alias, or is a system message
                const isRelevant = message.includes(debugMode.deviceId) || 
                                 (deviceAlias && message.includes(`"${deviceAlias}"`)) ||
                                 (deviceAlias && message.includes(deviceAlias));
                
                if (isRelevant) {
                    const timestamp = new Date().toISOString();
                    
                    // Format the log entry based on message type
                    let logEntry;
                    
                    // Check if this is a structured log (has emojis/separators)
                    if (message.includes('‚îÄ'.repeat(10)) || 
                        message.includes('‚ïê'.repeat(10)) ||
                        message.includes('üîå') || 
                        message.includes('üìã') ||
                        message.includes('‚úÖ') ||
                        message.includes('‚ùå')) {
                        // Structured message - keep formatting
                        logEntry = `\n${message}\n`;
                    } else {
                        // Simple message - add timestamp
                        logEntry = `[${timestamp}] ${message}\n`;
                    }
                    
                    try {
                        appendFileSync(`${debugMode.deviceId}.debug`, logEntry);
                    } catch (err) {
                        originalConsoleLog('‚ö†Ô∏è  Error writing console output to debug file:', err.message);
                    }
                }
            }
        };
    }

    /**
     * Write a custom message directly to debug log
     * (bypasses console.log interception)
     */
    static debugLogDirect(deviceID, message) {
        if (debugMode.enabled && debugMode.deviceId === deviceID) {
            const timestamp = new Date().toISOString();
            const logEntry = `[${timestamp}] ${message}\n`;
            try {
                appendFileSync(`${deviceID}.debug`, logEntry);
            } catch (err) {
                originalConsoleLog('Error writing direct message to debug file:', err);
            }
        }
    }

    /**
     * Log a separator line to debug file
     */
    static debugSeparator(deviceID, char = '‚îÄ', length = 80) {
        if (debugMode.enabled && debugMode.deviceId === deviceID) {
            const separator = `\n${char.repeat(length)}\n`;
            try {
                appendFileSync(`${deviceID}.debug`, separator);
            } catch (err) {
                originalConsoleLog('Error writing separator to debug file:', err);
            }
        }
    }

    /**
     * Log connection info to debug file
     */
    static debugConnection(deviceID, type, details) {
        if (debugMode.enabled && debugMode.deviceId === deviceID) {
            const timestamp = new Date().toISOString();
            const logEntry = `
${'‚îÄ'.repeat(80)}
[${timestamp}] CONNECTION ${type}
${'-'.repeat(80)}
${details}
${'‚îÄ'.repeat(80)}
`;
            try {
                appendFileSync(`${deviceID}.debug`, logEntry);
            } catch (err) {
                originalConsoleLog('Error writing connection info to debug file:', err);
            }
        }
    }

    /**
     * Log a raw message exchange to debug file
     */
    static debugMessage(deviceID, direction, messageType, content) {
        if (debugMode.enabled && debugMode.deviceId === deviceID) {
            const timestamp = new Date().toISOString();
            const logEntry = `
${'‚îÄ'.repeat(80)}
[${timestamp}] ${direction} - ${messageType}
${'-'.repeat(80)}
${content}
${'‚îÄ'.repeat(80)}
`;
            try {
                appendFileSync(`${deviceID}.debug`, logEntry);
            } catch (err) {
                originalConsoleLog('Error writing message to debug file:', err);
            }
        }
    }
}
