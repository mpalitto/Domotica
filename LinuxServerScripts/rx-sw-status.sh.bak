#!/bin/bash
nogood=""
sed '/^$/d' /root/switches.status > /root/switches.new.status
mv /root/switches.new.status /root/switches.status
echo >> /root/switches.status
#while true
#do
#  stdbuf -o0 netcat -l 1234 | tee -a /var/log/faillog | \
#  sed -n '$!H;${G;s/\n/ /g;p}' | \
#  sed '/deviceid/!d;s/.*deviceid":"//;s/".*switch":"/ /;s/".*//' | \
while true
do
  rx="$(stdbuf -o0 netcat -l 1234 | while read line; do echo $line; done)"
  echo -n "received: "
  echo $rx | sed '/deviceid/!d;s/.*deviceid":"//;s/".*switch":"/ /;s/".*//' 
  echo $rx | sed '/deviceid/!d;s/.*deviceid":"//;s/".*switch":"/ /;s/".*//' | \
  while read deviceid status
  do 
    echo "received: $deviceid $status" >> /var/log/faillog
    if [ "$deviceid" ] && [ "$status" ]; then 
      sed "/$deviceid/d; /^$/ i $deviceid $status" /root/switches.status > /root/switches.new.status
    else
      echo NOGOOD found
      notgood=true
    fi
  done
  if [ $nogood ]; then notgood=""; continue; fi
  # echo NEW:; cat /root/switches.new.status
  sed '/^$/d' /root/switches.new.status > /root/switches.status
  echo >> /root/switches.status
  echo ACTUAL:; cat /root/switches.status
  # exit
done
